---
title: "updated_veg_analysis"
author: "Jennifer Pannell"
date: "15 May 2019"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
library(tidyr)
library(plyr)
```

## Read data, remove NA values

```{r veg data}
dat<-read.csv("cover_class_data_long_all.csv", header=T)
# get rid of the NA's
dat<-na.omit(dat)

# strip white space from species names
dat$SpeciesName<-trimws(dat$SpeciesName)
dat$PlotNo<-trimws(dat$PlotNo)

# create unique plot ID column
dat$ID<-paste(dat$Farm,dat$PlotNo)
# read in plot data & merge
plots<-read.csv("plot_info.csv", header=T)
plots$PlotNo<-trimws(plots$PlotNo)
dat<-merge(plots, dat, by="PlotNo")

```

## Calculate stratum weights
```{r stratum weights}
variable<-levels(dat$variable)
# make height values for each class in order of levels - the difference between lowest & hightest values
height<-c(0.3, 15, 1.7, 13, 3, 7)
logheight<-log10(height)
values<-data.frame(variable,height,logheight)
rm(variable,height,logheight)
#merge with original data 

dat<-merge(dat,values, by="variable")

```

## Now calculate % cover abundance weights
```{r stratum weights}
value<-seq(0,7)
# make midpoint values for % cover abundance
midpoint<-c(0,0.5,3,8,18,38,63,88)
values2<-data.frame(value,midpoint)
rm(value,midpoint)
#merge with original data 

dat<-merge(dat,values2, by="value")

```

## In this codeblock, calculate an IV per species per plot 
```{r plot summaries}
# calculate the importance value with raw tier depth and % mid points
dat$IV<-dat$midpoint*dat$height

# make into a summary table - one row per species per plot
summary.plot<-dat[,18]%>%aggregate(by=list(dat$PlotID, dat$SpeciesName), FUN=sum, na.rm=T)
names(summary.plot)<-c("PlotID", "SpeciesName", "IV")

summary.plot<-merge(summary.plot,plots,by="PlotID")

write.csv(summary.plot, file="plot_IV.csv", row.names = F)

```

# Summarize by farm & vegetation class, and by species, calcluating mean and SD and total IV. 
```{r veg class summaries}
# make into a summary table - one row per species per farm
summary.vegclass<-summary.plot[,3]%>%aggregate(by=list(summary.plot$FarmName, summary.plot$VegClass, summary.plot$SpeciesName), FUN=mean, na.rm=T)
names(summary.vegclass)<-c("FarmName","VegClass", "SpeciesName", "MeanIV")
summary.vegclass$SDIV<-summary.plot[,3]%>%aggregate(by=list(summary.plot$FarmName, summary.plot$VegClass, summary.plot$SpeciesName), FUN=sd, na.rm=T)%>%.[,4]
summary.vegclass$SumIV<-summary.plot[,3]%>%aggregate(by=list(summary.plot$FarmName, summary.plot$VegClass, summary.plot$SpeciesName), FUN=sum, na.rm=T)%>%.[,4]
summary.vegclass<-summary.plot%>%count(vars=c("FarmName", "VegClass", "SpeciesName"))%>%merge(.,summary.vegclass, by=c("FarmName","VegClass", "SpeciesName"))

```

#Species lookup
Now merge with the NVS table to give us the scientific names of each species code
```{r merge scientific name from NVS}
names<-read.csv("CurrentNVSNames.csv", header=T)
summary.vegclass$SpeciesName<-toupper(summary.vegclass$SpeciesName)
names(summary.vegclass)[3]<-"NVSCode"
names$NVSCode<-toupper(names$NVSCode)

summary.vegclass<-merge(summary.vegclass, names[,c(1,3,5,6)], by="NVSCode", all.x=TRUE)
summary.vegclass<-summary.vegclass[order(summary.vegclass$FarmName, summary.vegclass$VegClass, -summary.vegclass$SumIV),]
```

#Burn data
How many of theses species do we have flammability data for?
```{r merge burn data}
burn<-read.table("burn_list.txt", header=T, sep="\t")
congen<-read.table("congener_list.txt", header=T, sep="\t")

summary.vegclass$burned<-summary.vegclass$NVSCode%in%burn$NVSName
summary.vegclass$congener<-summary.vegclass$NVSCode%in%congen$NVSName

```


```{r write file}
write.csv(summary.vegclass, file="farm_summaries.csv", row.names = F)

```

